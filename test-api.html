<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>API Test - Debug Mode</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        #results { margin-top: 20px; padding: 20px; border: 1px solid #ccc; background: #f9f9f9; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>API Test - Debug Mode</h1>
    <p>Testing portfolio APIs to identify the HTML vs JSON issue</p>
    
    <button onclick="testStatsSimple()">Test Stats (Simple)</button>
    <button onclick="testStatsWithHeaders()">Test Stats (With Headers)</button>
    <button onclick="testLikeSimple()">Test Like (Simple)</button>
    <button onclick="testLikeWithCSRF()">Test Like (With CSRF)</button>
    <button onclick="testFromModalContext()">Test From Modal Context</button>
    
    <div id="results"></div>

    <script>
        const guestUserId = Math.random().toString(36).substr(2, 9);
        
        function logResult(title, data, isError = false) {
            const resultsDiv = document.getElementById('results');
            const className = isError ? 'error' : 'success';
            resultsDiv.innerHTML = `<h3 class="${className}">${title}</h3><pre>${data}</pre>`;
        }
        
        async function testStatsSimple() {
            try {
                console.log('=== Testing Stats API (Simple) ===');
                const response = await fetch('/api/portfolio/works/teste/stats?user_id=1');
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                if (text.startsWith('<!DOCTYPE')) {
                    logResult('Stats Simple - ERROR: Received HTML instead of JSON', text, true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        logResult('Stats Simple - SUCCESS', JSON.stringify(data, null, 2));
                    } catch (e) {
                        logResult('Stats Simple - JSON Parse Error', text, true);
                    }
                }
            } catch (error) {
                logResult('Stats Simple - Network Error', error.message, true);
                console.error('Error:', error);
            }
        }

        async function testStatsWithHeaders() {
            try {
                console.log('=== Testing Stats API (With Headers) ===');
                const response = await fetch(`/api/portfolio/works/teste/stats?user_id=${guestUserId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                if (text.startsWith('<!DOCTYPE')) {
                    logResult('Stats With Headers - ERROR: Received HTML instead of JSON', text, true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        logResult('Stats With Headers - SUCCESS', JSON.stringify(data, null, 2));
                    } catch (e) {
                        logResult('Stats With Headers - JSON Parse Error', text, true);
                    }
                }
            } catch (error) {
                logResult('Stats With Headers - Network Error', error.message, true);
                console.error('Error:', error);
            }
        }

        async function testLikeSimple() {
            try {
                console.log('=== Testing Like API (Simple) ===');
                const formData = new FormData();
                formData.append('user_id', '6');
                
                const response = await fetch('/api/portfolio/works/teste/like', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                if (text.startsWith('<!DOCTYPE')) {
                    logResult('Like Simple - ERROR: Received HTML instead of JSON', text, true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        logResult('Like Simple - SUCCESS', JSON.stringify(data, null, 2));
                    } catch (e) {
                        logResult('Like Simple - JSON Parse Error', text, true);
                    }
                }
            } catch (error) {
                logResult('Like Simple - Network Error', error.message, true);
                console.error('Error:', error);
            }
        }

        async function testLikeWithCSRF() {
            try {
                console.log('=== Testing Like API (With CSRF) ===');
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                console.log('CSRF Token:', csrfToken);
                
                const formData = new FormData();
                formData.append('user_id', '6');
                
                const response = await fetch('/api/portfolio/works/teste/like', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData,
                    credentials: 'same-origin'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                const text = await response.text();
                console.log('Raw response:', text);
                
                if (text.startsWith('<!DOCTYPE')) {
                    logResult('Like With CSRF - ERROR: Received HTML instead of JSON', text, true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        logResult('Like With CSRF - SUCCESS', JSON.stringify(data, null, 2));
                    } catch (e) {
                        logResult('Like With CSRF - JSON Parse Error', text, true);
                    }
                }
            } catch (error) {
                logResult('Like With CSRF - Network Error', error.message, true);
                console.error('Error:', error);
            }
        }

        async function testFromModalContext() {
            try {
                console.log('=== Testing From Modal Context (Simulating exact modal behavior) ===');
                
                // First, simulate opening a modal by making a request to the home page
                await fetch('/', { method: 'GET', credentials: 'same-origin' });
                
                // Wait a bit
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Now test the stats API exactly like the modal does
                const response = await fetch(`/api/portfolio/works/teste/stats?user_id=${guestUserId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Modal Context - Response status:', response.status);
                console.log('Modal Context - Response headers:', [...response.headers.entries()]);
                
                const text = await response.text();
                console.log('Modal Context - Raw response:', text);
                
                if (text.startsWith('<!DOCTYPE')) {
                    logResult('Modal Context - ERROR: Received HTML instead of JSON', text.substring(0, 500) + '...', true);
                } else {
                    try {
                        const data = JSON.parse(text);
                        logResult('Modal Context - SUCCESS', JSON.stringify(data, null, 2));
                    } catch (e) {
                        logResult('Modal Context - JSON Parse Error', text, true);
                    }
                }
            } catch (error) {
                logResult('Modal Context - Network Error', error.message, true);
                console.error('Error:', error);
            }
        }
        
        // Auto-run a simple test on page load
        window.addEventListener('load', () => {
            console.log('Page loaded, running initial test...');
            testStatsSimple();
        });
    </script>
</body>
</html>